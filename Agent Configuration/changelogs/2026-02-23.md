# Changelog — 2026-02-23

## [14:10] Full plugin implementation from approved plan

- **File Modified**: `manifest.json` (new)
- **Change**: Created Obsidian plugin manifest — ID `zotero-mcp-chat`, desktop only, min version 0.15.0
- **Reason**: Required for Obsidian to recognize and load the plugin

---

- **File Modified**: `package.json` (new)
- **Change**: Created package config with ESM module type, esbuild + TypeScript dev dependencies
- **Reason**: Build toolchain for bundling TypeScript into the single `main.js` Obsidian expects

---

- **File Modified**: `tsconfig.json` (new)
- **Change**: Strict TypeScript config targeting ES6 with bundler module resolution
- **Reason**: Type safety for the plugin codebase

---

- **File Modified**: `esbuild.config.mjs` (new)
- **Change**: Build script that bundles `src/main.ts` → `main.js` (CJS format), externalizes obsidian/electron/codemirror
- **Logic Update**:
  ```
  entryPoints: src/main.ts → main.js
  format: CJS (Obsidian requirement)
  external: obsidian, electron, codemirror, node builtins
  watch mode for dev, single build for production
  ```
- **Reason**: Obsidian plugins must be a single CJS file with obsidian as an external

---

- **File Modified**: `versions.json` (new)
- **Change**: Maps plugin version 0.1.0 to minimum Obsidian version 0.15.0
- **Reason**: Required by Obsidian plugin spec

---

- **File Modified**: `src/types.ts` (new)
- **Change**: Defined `ZoteroMCPSettings` interface with MCP server, LLM provider (Ollama/OpenRouter/Anthropic), and behavior settings. Includes `DEFAULT_SETTINGS`, `ChatMessage`, and `ZoteroSource` types.
- **Logic Update**:
  ```
  ZoteroMCPSettings: mcpExecutablePath, mcpServerPort, llmProvider, per-provider configs
  Defaults: Ollama at localhost:11434, deepseek-r1:8b, port 8000
  ChatMessage: role, content, sources[], timestamp
  ZoteroSource: key, title, authors, year, itemType, abstract
  ```
- **Reason**: Central type definitions shared across all modules

---

- **File Modified**: `src/settings.ts` (new)
- **Change**: Settings tab with 3 sections: MCP Server (path, port), LLM Provider (dropdown that re-renders to show/hide provider-specific fields), Behavior (history length slider, system prompt)
- **Reason**: Users need to configure the MCP executable path, choose their LLM provider, and enter API keys

---

- **File Modified**: `src/mcp-server.ts` (new)
- **Change**: `MCPServerManager` class that spawns `zotero-mcp serve --transport streamable-http --port <port>` as a child process, polls the HTTP endpoint until ready (15s timeout), and kills the process on stop
- **Logic Update**:
  ```
  start(): spawn child process → poll /mcp with initialize request → return when ready
  stop(): SIGTERM the child process
  isRunning(): check process is alive
  stderr captured for error reporting (last 50 lines)
  ```
- **Reason**: Auto-manages the MCP server lifecycle so users don't need to start it manually

---

- **File Modified**: `src/mcp-client.ts` (new)
- **Change**: Minimal MCP client implementing JSON-RPC 2.0 over HTTP using Obsidian's `requestUrl`. Handles initialize handshake, session ID tracking, SSE response parsing, tool calls.
- **Logic Update**:
  ```
  initialize(): send initialize → send notifications/initialized
  callTool(name, args): JSON-RPC tools/call → parse text content from response
  Tracks Mcp-Session-Id header across requests
  Handles both JSON and SSE (text/event-stream) responses
  ```
- **Reason**: Custom implementation instead of MCP SDK because the SDK's Node HTTP deps don't work in Obsidian's Electron renderer. The protocol is simple JSON-RPC POSTs.

---

- **File Modified**: `src/llm/llm-provider.ts` (new)
- **Change**: `LLMProvider` interface with `chat(messages)`, `testConnection()`, `getModelName()`
- **Reason**: Abstraction layer so the orchestrator doesn't care which LLM is behind it

---

- **File Modified**: `src/llm/ollama.ts` (new)
- **Change**: Ollama provider using OpenAI-compatible `/v1/chat/completions` endpoint, connection test via `/api/tags`
- **Reason**: Primary provider — free, local, no API key needed

---

- **File Modified**: `src/llm/openrouter.ts` (new)
- **Change**: OpenRouter provider using same chat completions format with Bearer auth and referer headers
- **Reason**: Access to many models with a single API key

---

- **File Modified**: `src/llm/anthropic.ts` (new)
- **Change**: Anthropic provider using Messages API with system prompt in top-level field (not in messages array)
- **Reason**: Claude API has a different format from OpenAI-compatible endpoints

---

- **File Modified**: `src/llm/index.ts` (new)
- **Change**: Factory function `createLLMProvider(settings)` that returns the correct provider instance based on settings
- **Reason**: Single entry point for provider creation

---

- **File Modified**: `src/orchestrator.ts` (new)
- **Change**: Deterministic pipeline: (1) `zotero_semantic_search` with user question, (2) extract item keys, (3) `zotero_get_item_metadata` for each, (4) build context string, (5) send to LLM with conversation history (truncated to configurable limit)
- **Logic Update**:
  ```
  query(question, history):
    searchResult = mcpClient.callTool("zotero_semantic_search", {query})
    keys = extractItemKeys(searchResult)  // JSON parse or regex fallback
    sources = for each key: callTool("zotero_get_item_metadata", {item_key})
    context = format sources as numbered list with title/authors/year/abstract
    messages = [system prompt] + [recent history] + [context + question]
    return llmProvider.chat(messages)
  ```
- **Reason**: Fixed pipeline is more reliable than letting local models choose tools (per plan)

---

- **File Modified**: `src/chat-view.ts` (new)
- **Change**: `ItemView` subclass for right sidebar. DOM-based UI with: status dot (green/yellow/red), scrollable message list, markdown-rendered assistant responses, source citations below each response, copy button, clear chat button, textarea with Enter-to-send
- **Reason**: The user-facing chat panel, modeled after Obsidian Copilot

---

- **File Modified**: `src/main.ts` (new)
- **Change**: Plugin entry point. On load: loads settings, registers chat view, adds ribbon icon + command, starts MCP server in background. On unload: closes MCP client and kills server process. Re-creates orchestrator when settings change.
- **Reason**: Wires all components together into the Obsidian plugin lifecycle

---

- **File Modified**: `styles.css` (new)
- **Change**: Flexbox layout for chat panel using Obsidian CSS variables (`--background-primary`, `--text-normal`, `--interactive-accent`, etc.) for light/dark theme compatibility. User messages right-aligned with accent color, assistant messages left-aligned with secondary background.
- **Reason**: Match Obsidian's native look and feel
