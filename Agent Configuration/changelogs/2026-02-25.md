## [~15:00] Remove 4000-character truncation from attached notes

- **File Modified**: `src/chat-view.ts`
- **Change**: Removed the `fullTextMaxChars` limit from `attachActiveNote()`. Full note content is now sent to the LLM with no cap.
- **Logic Update**:
  ```
  attachActiveNote():
    content = vault.read(file)   # no slice, no truncation
    attachedNote = { name, path, content }
  ```
- **Reason**: The 4000-char limit was set assuming a local Ollama model with a small context window, but the plugin is used with cloud models that have much larger contexts. Notes longer than 4000 chars (e.g. 17,000+) were being silently cut off.

---

## [~15:30] Fix 500 error — separate attached note from semantic search query

- **Files Modified**: `src/chat-view.ts`, `src/orchestrator.ts`
- **Change**: Previously, the attached note's full content was prepended to `orchestratorQuestion`, which was then passed to the MCP server as the semantic search query. This caused HTTP 500 errors (the MCP server and/or LLM API rejecting the enormous query string). Now the raw user question is used for search, and the note is passed as a separate parameter only to the LLM message builder.
- **Logic Update**:
  ```
  handleSend():
    orchestrator.query(rawQuestion, history, attachedNote)  # note separated out

  orchestrator.query(question, history, attachedNote?):
    mcpClient.callTool("zotero_semantic_search", { query: question })  # clean query
    ...
    buildMessages(question, context, history, attachedNote)  # note added here only
  ```
- **Reason**: Passing a 17K-character note as a search query produces irrelevant results and overloads the MCP server. The note is context for the LLM response, not a search term.

---

## [~16:30] Add @ note picker, multi-note attachment, Copilot-inspired UI

- **Files Modified**: `src/chat-view.ts`, `src/orchestrator.ts`
- **Change**: Replaced the paperclip button (attaches active note only) with an `@` button that opens Obsidian's built-in fuzzy note picker. Multiple notes can now be attached simultaneously, each rendered as a removable pill. Updated header icons: new chat uses `square-pen`, save uses `file-output`. Added `NotePicker` class using `FuzzySuggestModal<TFile>`. Changed `attachedNote` (single) to `attachedNotes` (array) throughout; orchestrator updated to include all notes in LLM context.
- **Logic Update**:
  ```
  NotePicker extends FuzzySuggestModal<TFile>:
    getItems() → vault.getMarkdownFiles()
    onChooseItem(file) → attachNote(file)

  attachNote(file):
    if already attached → Notice, return
    content = vault.read(file)
    attachedNotes.push({ name, path, content })
    renderAttachmentChips()

  handleSend():
    notesSnapshot = [...attachedNotes]
    attachedNotes = []          # clear immediately
    orchestrator.query(rawQuestion, history, notesSnapshot)
  ```
- **Reason**: Copilot-inspired UX. The `@` button is more discoverable and explicit than a paperclip. Multi-note support lets users provide richer context per question.

---

## [~17:00] Add README for PhD student beta testers

- **File Added**: `README.md`
- **Change**: Full setup guide covering Ollama installation + model selection, zotero-mcp setup with opinionated settings recommendations (local API, default embeddings, daily updates, full-text indexing), BRAT-based plugin installation, plugin configuration, usage tips, and troubleshooting.
- **Reason**: Plugin is being shared with non-technical PhD students for beta testing. The README avoids jargon and gives specific recommended choices for every decision point rather than linking to upstream docs and leaving users to figure it out.

---

## [~17:15] Add GitHub Actions auto-release workflow

- **File Added**: `.github/workflows/release.yml`
- **Change**: Workflow triggers on every push to `main`, builds the plugin (`npm ci && npm run build`), reads the version from `manifest.json`, and creates or updates a GitHub release with `main.js`, `manifest.json`, and `styles.css` as assets. Uses `ncipollo/release-action` with `allowUpdates: true` so repeated pushes on the same version overwrite rather than fail.
- **Reason**: BRAT (the standard Obsidian beta plugin installer) requires a GitHub release with compiled assets. The workflow automates this so testers always get the latest build without manual release management.

---

## [~17:45] Rename repo to zotero-obsidian-chat; make public

- **Files Modified**: `README.md`, `.gitignore`, `Agent Configuration/memory/PROJECT_MAP.md`
- **Change**: Repository renamed from `zotero-obsidian-plugin` to `zotero-obsidian-chat` and made public. Updated git remote URL, all README links, and memory files. Added `USER_INSIGHTS.md` to `.gitignore` and removed it from git tracking (privacy — file stays on disk but is no longer pushed to the public repo).
- **Reason**: The new name better describes what the plugin does. Making the repo public enables BRAT installation and wider beta testing.

---

## [~14:00] Fix UI squash and server reuse across plugin reloads

- **File Modified**: `src/chat-view.ts`
- **Change**: Added `ResizeObserver` at the end of `onOpen()` that watches the panel element for its first non-zero height, then fires `workspace.trigger("resize")` once and disconnects.
- **Logic Update**:
  ```
  onOpen():
    ... (existing setup) ...
    sizeObserver = new ResizeObserver:
      if entry.height > 0:
        disconnect observer
        workspace.trigger("resize")

  onClose():
    sizeObserver?.disconnect()
  ```
- **Reason**: `height: 100%` on the chat container resolves to 0 until Obsidian finalises sidebar panel dimensions after a layout pass. Previously the layout only self-corrected when the server connected (~30s), making the panel look squashed for the full cold-start window. The ResizeObserver fires at exactly the right moment (when the panel first gets real dimensions), independently of server startup speed.

---

## [~14:00] Keep zotero-mcp server alive across plugin reloads

- **File Modified**: `src/mcp-server.ts`
- **Change**: `stop()` no longer sends SIGTERM. Added `usingExternalProcess` flag and `tryReuseExistingServer()` method. `start()` now checks for an existing warm server before spawning a new one.
- **Logic Update**:
  ```
  stop():
    process = null          # drop reference only — do NOT kill
    usingExternalProcess = false

  start():
    if tryReuseExistingServer():
      return                # reuse warm server, skip cold start

    killStaleMCPProcess()   # only if port is held by something unusable
    spawn new process
    waitForReady()

  tryReuseExistingServer():
    if lsof shows nothing on port → return false
    if HTTP probe returns any status → set usingExternalProcess = true, return true
    return false

  isRunning():
    return usingExternalProcess OR (process != null AND exitCode == null)
  ```
- **Reason**: Obsidian's "reload app without saving" is a soft renderer reload — it does not kill child processes. The zotero-mcp server spawned by the plugin survives reloads. Previously, `stop()` sent SIGTERM and killed this warm server, forcing a 30-60s cold start on every reload. Now the server stays alive and is reused immediately, making both "reload app" and "toggle plugin" near-instant after the first cold start.

---

## [~14:00] Improve crash diagnostics and post-connect layout refresh

- **File Modified**: `src/main.ts`
- **Change**: `onUnexpectedExit` now logs the last stderr lines to the developer console. After server connects, the code now explicitly calls `updateStatus()` on any open chat views and fires `workspace.trigger("resize")`.
- **Reason**: Stderr lines contain the Python traceback when zotero-mcp crashes; without logging them, diagnosing crashes required attaching a debugger. The post-connect resize ensures the layout is always correct even if the ResizeObserver already fired before the server was ready.
