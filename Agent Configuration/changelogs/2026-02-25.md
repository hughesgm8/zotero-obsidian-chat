## [~14:00] Fix UI squash and server reuse across plugin reloads

- **File Modified**: `src/chat-view.ts`
- **Change**: Added `ResizeObserver` at the end of `onOpen()` that watches the panel element for its first non-zero height, then fires `workspace.trigger("resize")` once and disconnects.
- **Logic Update**:
  ```
  onOpen():
    ... (existing setup) ...
    sizeObserver = new ResizeObserver:
      if entry.height > 0:
        disconnect observer
        workspace.trigger("resize")

  onClose():
    sizeObserver?.disconnect()
  ```
- **Reason**: `height: 100%` on the chat container resolves to 0 until Obsidian finalises sidebar panel dimensions after a layout pass. Previously the layout only self-corrected when the server connected (~30s), making the panel look squashed for the full cold-start window. The ResizeObserver fires at exactly the right moment (when the panel first gets real dimensions), independently of server startup speed.

---

## [~14:00] Keep zotero-mcp server alive across plugin reloads

- **File Modified**: `src/mcp-server.ts`
- **Change**: `stop()` no longer sends SIGTERM. Added `usingExternalProcess` flag and `tryReuseExistingServer()` method. `start()` now checks for an existing warm server before spawning a new one.
- **Logic Update**:
  ```
  stop():
    process = null          # drop reference only — do NOT kill
    usingExternalProcess = false

  start():
    if tryReuseExistingServer():
      return                # reuse warm server, skip cold start

    killStaleMCPProcess()   # only if port is held by something unusable
    spawn new process
    waitForReady()

  tryReuseExistingServer():
    if lsof shows nothing on port → return false
    if HTTP probe returns any status → set usingExternalProcess = true, return true
    return false

  isRunning():
    return usingExternalProcess OR (process != null AND exitCode == null)
  ```
- **Reason**: Obsidian's "reload app without saving" is a soft renderer reload — it does not kill child processes. The zotero-mcp server spawned by the plugin survives reloads. Previously, `stop()` sent SIGTERM and killed this warm server, forcing a 30-60s cold start on every reload. Now the server stays alive and is reused immediately, making both "reload app" and "toggle plugin" near-instant after the first cold start.

---

## [~14:00] Improve crash diagnostics and post-connect layout refresh

- **File Modified**: `src/main.ts`
- **Change**: `onUnexpectedExit` now logs the last stderr lines to the developer console. After server connects, the code now explicitly calls `updateStatus()` on any open chat views and fires `workspace.trigger("resize")`.
- **Reason**: Stderr lines contain the Python traceback when zotero-mcp crashes; without logging them, diagnosing crashes required attaching a debugger. The post-connect resize ensures the layout is always correct even if the ResizeObserver already fired before the server was ready.
