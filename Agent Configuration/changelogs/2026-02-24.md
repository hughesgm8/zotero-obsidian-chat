# Changelog — 2026-02-24

## [Session 1] Fix: detect server errors early + notify on unexpected crash

- **File Modified**: `src/orchestrator.ts`
- **Change**: Added `looksLikeError(text)` private method. After `zotero_semantic_search` returns, the orchestrator checks if the result looks like an error message rather than real data. If it does, it throws immediately so the chat shows a plain error instead of passing the error text to the LLM as "context."
- **Logic Update**:
  ```
  looksLikeError(text):
    Returns true if text contains "already exists", "collection [",
    or starts with "error" without being JSON

  query():
    searchResult = callTool("zotero_semantic_search", ...)
    if looksLikeError(searchResult) → throw "The Zotero server returned an error: ..."
    (rest of pipeline unchanged)
  ```
- **Reason**: `zotero-mcp` does not reliably set `isError: true` on tool errors — it sometimes returns errors as plain text content. The previous `isError` fix in `mcp-client.ts` didn't catch this. Text-matching at the orchestrator level is the fallback. Now instead of DeepSeek getting "Collection [zotero_library] already exists" as "search context" and producing a confused response, the user sees a direct error message in the chat.

---

- **File Modified**: `src/mcp-server.ts`
- **Change**: Added public `onUnexpectedExit: (() => void) | null` field. The exit handler calls this callback when the process exits with a non-zero code (i.e. crashes rather than being deliberately stopped).
- **Logic Update**:
  ```
  onUnexpectedExit = null  (set from outside after construction)

  exit handler:
    BEFORE: logged code, set process = null, set lastError
    AFTER:  logs code, sets process = null, sets lastError,
            calls onUnexpectedExit?.() if code !== 0
  ```
- **Reason**: The server was crashing silently mid-session — the status dot stayed green and the user had no feedback until the next query failed with a confusing error.

---

- **File Modified**: `src/main.ts`
- **Change**: After constructing `MCPServerManager`, sets `onUnexpectedExit` to show a 10-second Notice and turn the status dot red in any open chat views. Also added `await` to the `startMCPServer()` call (it was fire-and-forget before; now properly awaited).
- **Logic Update**:
  ```
  mcpServer.onUnexpectedExit = () => {
    new Notice("Zotero Chat: The Zotero server stopped unexpectedly...", 10000)
    for each open chat leaf → leaf.view.updateStatus()
  }
  ```
- **Reason**: Surfaces the crash to the user immediately with an actionable message.

---

- **File Modified**: `src/chat-view.ts`
- **Change**: Made `updateStatus()` public (was `private`).
- **Reason**: Required so `main.ts` can trigger a status dot refresh when the server crashes externally.
